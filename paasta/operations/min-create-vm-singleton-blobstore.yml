- type: remove
  path: /instance_groups/name=database/migrated_from/name=blobstore?
- type: remove
  path: /instance_groups/name=database/jobs/name=blobstore
- type: remove
  path: /instance_groups/name=database/jobs/name=route_registrar/properties/route_registrar/routes/name=blobstore
- type: replace
  path: /instance_groups/name=database/persistent_disk_type
  value: ((database_persistent_disk_type))

- type: replace
  path: /instance_groups/name=control:before
  value:
    name: singleton-blobstore
    migrated_from:
    - name: blobstore
    azs: ((singleton_blobstore_azs))
    instances: ((singleton_blobstore_instances))
    vm_type: ((singleton_blobstore_vm_type))
    persistent_disk_type: ((singleton_blobstore_persistent_disk_type))
    stemcell: default
    update:
      serial: true
    networks:
    - name: default
    jobs:
    - name: blobstore
      release: capi
      properties:
        system_domain: "((system_domain))"
        blobstore:
          admin_users:
          - username: blobstore-user
            password: "((blobstore_admin_users_password))"
          secure_link:
            secret: "((blobstore_secure_link_secret))"
          tls:
            cert: "((blobstore_tls.certificate))"
            private_key: "((blobstore_tls.private_key))"
    - name: route_registrar
      release: routing
      properties:
        nats:
          tls:
            client_cert: "((nats_client_cert.certificate))"
            client_key: "((nats_client_cert.private_key))"
            enabled: true
        route_registrar:
          routes:
          - name: blobstore
            port: 8080
            registration_interval: 20s
            tags:
              component: blobstore
            uris:
            - blobstore.((system_domain))

# CCE - PaaS-TA blobstore/nginx patch : 7vms
- type: replace
  path: /instance_groups/name=singleton-blobstore/jobs/-
  value:
    name: common_script
    release: paasta-conf
    properties:
      pre_start_script: |+
        #!/bin/bash
        sed -i'' -r -e "/keepalive_timeout/i\  disable_symlinks    on;" /var/vcap/jobs/blobstore/config/nginx.conf
        echo "added disable_symlinks in nginx.conf"
