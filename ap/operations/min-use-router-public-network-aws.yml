- type: replace
  path: /releases/name=ap-conf?
  value:
    name: ap-conf
    url:  https://nextcloud.k-paas.org/index.php/s/qKWKjAS4omLHgZk/download
    version: 1.0.7.1

- type: replace
  path: /instance_groups/name=router/jobs/-
  value:
    name: common_script
    release: ap-conf
    properties:
      pre_start_script: |-
        #!/bin/bash
        for target in $(find / -name haproxy.conf* ); do
          echo "$target"
          pCount=`cat $target | grep tcp-trafficcontroller | wc -l`
          echo "config in tcp-trafficcontroller : ${pCount}"
          if [ ${pCount} -eq "0" ] ; then
            echo "haproxy.conf add wss : 4443 : $target"
            {
            echo ' '
            echo 'frontend tcp-frontend-trafficcontroller'
            echo '    mode tcp'
            echo '    bind :4443'
            echo '    default_backend tcp-trafficcontroller'
            echo ' '
            echo 'backend tcp-trafficcontroller'
            echo '    mode tcp'
            echo '    server node0 loggregator-trafficcontroller.service.cf.internal:8081 check inter 1000'
            } >> $target
          fi
        done
        ps -ef | grep haproxy
        echo "if you see haproxy process then require monit restart tcp_router"
